# 大姨 App - 产品功能文档

## 一、产品概述

**产品名称：** 大姨

**产品定位：** 简洁易用的月经周期追踪应用

**核心价值：**
- 快速记录和编辑月经日期
- 可视化展示经期状态和周期规律
- 统计分析历史周期数据，帮助用户了解自身规律

---

## 二、页面结构

### 页面导航图

```
首页（HomeView）
├── 日期选择器（DatePickerFullScreenContent）
├── 周期统计页面（CycleStatsView）
└── 经期长度统计页面（PeriodLengthStatsView）
```

---

## 三、功能详解

---

### 3.1 首页（HomeView）

#### 页面概览
首页是用户的主要交互界面，展示当前日期的经期状态、周历选择器和月经周期信息卡片。

---

#### 功能模块

##### 1. 日期显示区域
**位置：** 页面顶部

**显示内容：**
- 当前日期：中文格式（例："1月4日"）

**交互：** 无交互，仅展示

**业务逻辑：**
- 根据用户滑动周历或经期状态卡片，自动更新显示的日期
- 日期格式固定为"M月d日"

---

##### 2. 周历选择器
**位置：** 日期显示下方

**显示内容：**
- 当前周的7天日期
- 每个日期显示：
  - 星期（周一~周日）
  - 日期数字
- 选中日期：蓝色高亮显示
- 经期日期：红色实心圆点标记（在日期数字下方）
- 今天：如果是今天且未选中，显示蓝色空心圆点

**交互：**
- **点击日期：** 切换选中的日期，下方经期状态卡片自动更新
- **左右滑动：** 切换到前一周或后一周
  - 向左滑动 → 查看下一周
  - 向右滑动 → 查看上一周

**业务逻辑：**
- 周从周一开始，到周日结束
- 滑动切换周时，保持选中状态在同一星期（例如：选中周三，滑动后仍选中新一周的周三）
- 经期标记根据用户记录的月经日期动态显示

---

##### 3. 经期状态卡片（轮播）
**位置：** 周历选择器下方，占据页面中部大片区域

**显示内容：**
根据选中日期的经期状态，显示不同内容：

**状态1：未记录任何经期**
- 单行文案："记录你上一次经期开始的日期"

**状态2：选中日期在经期内**
- 第一行："经期"
- 第二行："第 X 天"（X为该次经期的第几天）

**状态3：选中日期在经期之后**
- 第一行："过去的月经周期"
- 第二行："第 X 天"（X为从该经期**开始日**到选中日期的天数）

**注意：** 第三种状态计算的是从经期开始日算起的天数，而不是从经期结束日算起

**交互：**
- **左右滑动：** 切换到前一天或后一天
  - 向左滑动 → 查看后一天
  - 向右滑动 → 查看前一天
- 滑动时，上方周历同步更新选中日期
- 滑动时，背景颜色平滑过渡

**业务逻辑：**
- 根据选中日期与最新经期记录的关系，判断显示的状态
- 如果选中日期在经期内，显示"经期 - 第X天"
- 如果选中日期在经期之后，显示"过去的月经周期 - 第X天"
- 如果没有任何记录，显示引导文案

**视觉设计：**
- 经期内：红粉色渐变背景
  - 顶部：#FEE5EA
  - 底部：#FF5A7D
- 非经期：米白色渐变背景
  - 顶部：#F3E9E6
  - 底部：#FEFDFD
- 滑动切换日期时，背景渐变平滑过渡（使用 easeOut 动画）
- 整体背景色：
  - 经期内：#FEEBF0
  - 非经期：#F8F3F1

---

##### 4. 记录/编辑按钮
**位置：** 经期状态卡片下方

**显示内容：**
- **选中日期不在经期内：** "记录月经"
- **选中日期在经期内：** "编辑月经日期"

**交互：**
- 点击按钮 → 打开日期选择器页面（全屏页面式，使用 NavigationLink）

**业务逻辑：**
- 按钮文案和样式根据**选中日期**是否在经期内动态变化
- 不是根据是否有历史记录，而是根据当前选中的日期状态

**视觉设计：**
- 选中日期不在经期内：粉底 (#FF5A7D) + 白色文字
- 选中日期在经期内：白底 + 粉色文字 (#FF5A7D)
- 圆角：按钮高度的一半（完全圆角）
- 带轻微阴影和边缘模糊效果

---

##### 5. 月经周期信息卡片
**位置：** 页面底部

**显示内容：**
分为三个信息行：

**第1行：上一个周期天数**
- 显示格式："上一个周期天数：X天 ✓正常"
- "✓正常"为绿色
- 如果没有完成的周期，不显示此行

**第2行：月经周期天数变化**
- 显示格式："月经周期天数变化：平均X天"
- 右侧显示箭头符号（表示可跳转）
- 如果没有完成的周期，显示"-"

**第3行：经期长度变化**
- 显示格式："经期长度变化：平均X天"
- 右侧显示箭头符号（表示可跳转）
- 如果没有历史经期，显示"-"

**交互：**
- **点击第1行：** 无交互
- **点击第2行：** 跳转到"周期统计页面"
- **点击第3行：** 跳转到"经期长度统计页面"

**业务逻辑：**
- 上一个周期天数：最近一个完成的周期天数（从一个经期开始到下一个经期开始的天数）
- 平均周期天数：所有完成周期的平均值（**整数除法，不向上取整**）
- 平均经期天数：所有历史经期的平均值（**整数除法，不向上取整**）

---

### 3.2 日期选择器（DatePickerFullScreenContent）

#### 页面概览
全屏页面式日期选择器，用于记录和编辑月经日期。支持多日期选择、自动预测、智能扩展等功能。

---

#### 功能模块

##### 1. 顶部工具栏
**位置：** 页面顶部

**显示内容：**
- 左侧："取消"按钮
- 中间："今天"按钮（仅当今天未选中时显示）
- 右侧："保存"按钮

**交互：**
- **点击"取消"：** 关闭日期选择器，不保存任何更改，返回首页
- **点击"今天"：** 滚动到今天所在月份，并选中今天
- **点击"保存"：** 保存当前选中的日期，关闭日期选择器，返回首页

**业务逻辑：**
- "今天"按钮只在今天未被选中时显示
- "保存"按钮无论是否有变更，都可点击

---

##### 2. 月历网格
**位置：** 占据页面主要区域

**显示内容：**
- 按月份分组显示日期
- 每月显示：
  - 月份标题："YYYY年M月"
  - 星期标题行：周一 ~ 周日
  - 日期网格：6行7列的日期格子

**日期范围：**
- 历史：从今天往前推 60 个月（5年历史）
- 未来：到今天所在周的周日，再往后 2 周（到第三个周日）
  - 例如：今天是周三，则显示到本周日 + 14天
  - 最后一天始终是周日

**日期状态：**
日期格子有以下几种状态：

**普通日期：**
- 显示：日期数字，黑色
- 可点击

**已选中日期：**
- 显示：日期数字，白色，红色实心圆形背景
- 可点击取消选中

**可扩展日期：**
- 显示：日期数字，红色，红色虚线边框（圆形虚线框）
- 可点击选中（扩展当前经期段）
- **仅在未来日期显示虚线框**（今天及之前的可扩展日期显示为普通样式）

**禁用日期：**
- 显示：日期数字，灰色
- 不可点击
- 说明：超过可扩展日期范围的远期未来日期

**非本月日期：**
- 显示：空白（不显示日期数字）
- 不可点击

**交互：**
- **点击普通日期：** 选中该日期
  - 如果是新的经期段，自动预测并选中后续6天（共7天）
  - 如果前一天已被选中，则追加到当前经期段
- **点击已选中日期：** 取消选中该日期
  - 如果取消的是经期段的中间日期，则拆分为两个经期段
  - 如果取消的是经期段的起始或结束日期，则缩短经期段
- **点击可扩展日期：** 选中该日期，扩展当前经期段
- **点击禁用日期：** 无反应

**业务逻辑：**

**自动预测规则：**
- 当用户点击一个新日期时（不属于任何已选经期段，且不是可扩展日期），检查是否满足预测条件：
  - **条件 A（与下一次经期的距离）：**
    - 如果有下一次经期：当前日期到下次经期开始日 ≥ 10天
    - 如果没有下一次经期：条件成立
  - **条件 B（与上一次经期的距离）：**
    - 如果有上一次经期：上次经期结束日到当前日期 ≥ 6天
    - 如果没有上一次经期：条件成立
- 只有**条件 A 和条件 B 同时满足**时，才触发自动预测
- 自动预测：从选中日期开始，连续选中后续 6 天（共 7 天，因为 `defaultPredictionDays = 6` 但包含起始日）
- **修正：** 实际预测是选中 **6 天**（不包含起始日），代码中 `for i in 0..<defaultPredictionDays` 表示选中 0~5 共 6 个后续日期

**可扩展规则：**
- 每个经期段的最后一天的下一天，显示为"可扩展日期"
- 点击可扩展日期，会将其加入当前经期段
- 加入后，新的下一天继续显示为可扩展

**日期合并规则：**
- 如果两个经期段之间的间隔被填满，自动合并为一个经期段
- 例如：1月1-3日和1月5-7日之间，如果选中1月4日，则合并为1月1-7日

**日期拆分规则：**
- 如果取消选中一个经期段的中间日期，该经期段会拆分为两个
- 例如：1月1-7日，如果取消选中1月4日，则拆分为1月1-3日和1月5-7日

**滚动行为：**
- 页面打开时，自动滚动到**底部**（显示今天所在月份及未来日期）
- 滚动定位使用底部标记点（"BOTTOM" marker）确保准确定位
- 为防止打开时内容闪动，在滚动完成前隐藏内容（opacity = 0）
- 用户可上下滚动浏览历史和未来的月份

---

### 3.3 周期统计页面（CycleStatsView）

#### 页面概览
展示用户的月经周期统计数据，包括平均周期天数、当前进行中的周期、历史完成的周期。

---

#### 功能模块

##### 1. 顶部导航栏
**位置：** 页面顶部

**显示内容：**
- 标题："周期天数"
- 左侧返回按钮（系统默认样式）

**交互：**
- 点击返回按钮 → 返回首页
- 支持侧滑返回手势

---

##### 2. 统计头部信息
**位置：** 导航栏下方

**显示内容：**
- "平均周期天数：X天"

**业务逻辑：**
- 平均周期天数：所有完成周期的平均值（整数除法）
- 如果没有完成的周期，显示 "-" 或不显示数值

---

##### 3. 当前周期卡片
**位置：** 统计头部下方

**显示内容：**
- 标题："当前周期"
- 日期范围："YYYY.M.d - 至今"
- 周期天数："X天"
- 进度条：以平均周期天数为基准的进度条
  - 进度条颜色：蓝色
  - 进度条背景：灰色
  - 进度 = 当前周期天数 / 平均周期天数
  - 如果超过平均值，进度条填满并继续显示实际天数

**业务逻辑：**
- 当前周期：从最新一次经期开始日到今天
- 如果没有记录，不显示此卡片
- 如果有第二次经期记录（即有完成的周期），才显示此卡片

**交互：** 无交互

---

##### 4. 历史周期列表
**位置：** 当前周期卡片下方

**显示内容：**
- 列表标题："历史周期"
- 每个周期卡片显示：
  - 日期范围："YYYY.M.d - YYYY.M.d"
  - 周期天数："X天"
  - 进度条：以平均周期天数为基准的进度条
    - 进度条颜色：蓝色
    - 进度条背景：灰色
    - 进度 = 该周期天数 / 平均周期天数

**排序规则：**
- 从最新到最旧排序（最新的在上面）

**业务逻辑：**
- 周期定义：从一个经期开始日到下一个经期开始日的前一天
- 只显示完成的周期（即至少有两次经期记录）
- 如果没有完成的周期，不显示此列表

**交互：** 无交互

---

##### 5. 平均参考线
**位置：** 覆盖在所有进度条上

**显示内容：**
- 一条垂直虚线，标记平均周期天数的位置
- 虚线颜色：橙色

**业务逻辑：**
- 虚线位置 = 平均周期天数对应的进度条位置
- 帮助用户快速对比每个周期与平均值的关系

---

### 3.4 经期长度统计页面（PeriodLengthStatsView）

#### 页面概览
展示用户的经期长度统计数据，包括平均经期天数、当前进行中的经期、历史经期。

---

#### 功能模块

##### 1. 顶部导航栏
**位置：** 页面顶部

**显示内容：**
- 标题："经期天数"
- 左侧返回按钮（系统默认样式）

**交互：**
- 点击返回按钮 → 返回首页
- 支持侧滑返回手势

---

##### 2. 统计头部信息
**位置：** 导航栏下方

**显示内容：**
- "平均经期天数：X天"

**业务逻辑：**
- 平均经期天数：所有历史经期的平均值（整数除法）
- 如果没有经期记录，显示 "-" 或不显示数值

---

##### 3. 当前经期卡片
**位置：** 统计头部下方

**显示内容：**
- 标题："当前经期"
- 日期范围："YYYY.M.d - 至今"
- 经期天数："X天"
- 进度条：以平均经期天数为基准的进度条
  - 进度条颜色：红色
  - 进度条背景：灰色
  - 进度 = 当前经期天数 / 平均经期天数
  - 如果超过平均值，进度条填满并继续显示实际天数

**业务逻辑：**
- 当前经期：最新的经期记录
- **显示条件：** 需要检查最新经期是否包含今天或今天之后的日期
- 当前经期天数 = 经期记录中**今天及之前**的日期数量（不包含未来预测的日期）
- 如果最新经期已完全结束（所有日期都在今天之前），不显示此卡片

**交互：** 无交互

---

##### 4. 历史经期列表
**位置：** 当前经期卡片下方

**显示内容：**
- 列表标题："历史经期"
- 每个经期卡片显示：
  - 日期范围："YYYY.M.d - YYYY.M.d"
  - 经期天数："X天"
  - 进度条：以平均经期天数为基准的进度条
    - 进度条颜色：红色
    - 进度条背景：灰色
    - 进度 = 该经期天数 / 平均经期天数

**排序规则：**
- 从最新到最旧排序（最新的在上面）
- 如果当前有进行中的经期，则历史经期不包含当前经期

**业务逻辑：**
- 经期定义：用户选中的连续日期段
- 历史经期：除当前经期外的所有经期记录
- 如果没有历史经期，不显示此列表

**交互：** 无交互

---

##### 5. 平均参考线
**位置：** 覆盖在所有进度条上

**显示内容：**
- 一条垂直虚线，标记平均经期天数的位置
- 虚线颜色：橙色

**业务逻辑：**
- 虚线位置 = 平均经期天数对应的进度条位置
- 帮助用户快速对比每个经期与平均值的关系

---

## 四、核心业务逻辑

### 4.1 数据结构

#### 经期记录（PeriodRecord）
每条经期记录包含：
- 唯一标识符（UUID）
- 日期集合（可以是连续或间断的日期）
- 经期开始日（日期集合中的最早日期）
- 经期结束日（日期集合中的最晚日期）
- 经期天数（日期集合中的日期数量）

#### 周期数据（CycleData）
每个周期包含：
- 开始日期（本次经期开始日）
- 结束日期（下次经期开始日的前一天）
- 周期天数（结束日期 - 开始日期 + 1）

#### 当前周期数据（CurrentCycleData）
进行中的周期包含：
- 开始日期（最新经期开始日）
- 周期天数（从开始日期到今天的天数）

#### 经期数据（PeriodData）
历史经期包含：
- 开始日期（经期开始日）
- 结束日期（经期结束日）
- 经期天数（经期日期数量）

#### 当前经期数据（CurrentPeriodData）
进行中的经期包含：
- 开始日期（经期开始日）
- 经期天数（从开始日期到今天的天数）

---

### 4.2 计算逻辑

#### 周期计算
**定义：** 从一个经期开始日到下一个经期开始日的前一天

**计算方法：**
1. 按经期开始日从早到晚排序所有经期记录
2. 遍历相邻的两个经期记录
3. 计算第一个经期的开始日到第二个经期开始日前一天的天数
4. 得到一个完成的周期

**示例：**
- 经期1：1月1日 - 1月7日
- 经期2：1月29日 - 2月4日
- 周期天数 = (1月29日 - 1月1日) = 28天

**当前周期：**
- 如果至少有一个经期记录，计算最新经期开始日到今天的天数
- 如果没有经期记录，无当前周期

---

#### 平均周期天数
**计算方法：**
1. 获取所有完成的周期
2. 计算所有周期天数的总和
3. 除以周期数量（整数除法，不向上取整）

**示例：**
- 周期1：28天
- 周期2：30天
- 周期3：27天
- 平均周期天数 = (28 + 30 + 27) / 3 = 85 / 3 = 28天（整数除法）

---

#### 平均经期天数
**计算方法：**
1. 获取所有经期记录
2. 计算所有经期天数的总和
3. 除以经期数量（整数除法，不向上取整）

**示例：**
- 经期1：7天
- 经期2：6天
- 经期3：5天
- 平均经期天数 = (7 + 6 + 5) / 3 = 18 / 3 = 6天（整数除法）

---

#### 经期状态判断
**输入：** 选中日期

**输出：** 经期状态（经期前、经期中、经期后）

**判断逻辑：**
1. 如果没有任何经期记录 → 经期前（显示引导文案）
2. 如果选中日期在最新经期记录的日期集合中 → 经期中
3. 如果选中日期在最新经期结束日之后 → 经期后
4. 其他情况 → 经期前

---

### 4.3 数据持久化

#### 存储方式
使用 UserDefaults 本地存储

#### 存储内容
- 经期记录列表（JSON格式）

#### 存储格式
```json
{
  "periodRecords": [
    {
      "id": "UUID字符串",
      "dateIntervals": [时间戳1, 时间戳2, ...]
    },
    ...
  ]
}
```

#### 数据迁移
支持从旧版本数据格式迁移到新版本：
- 旧版本：单一经期记录（单个日期范围）
- 新版本：多个经期记录（多个日期范围）

---

## 五、用户操作流程

### 5.1 首次使用流程

1. 用户打开 App
2. 首页显示引导文案："记录你上一次经期开始的日期"
3. 用户点击"记录月经"按钮
4. 进入日期选择器页面
5. 用户点击上一次经期开始的日期（例如：1月1日）
6. 系统自动选中1月1日-1月7日（默认7天）
7. 用户可以：
   - 点击取消多余的日期（例如取消1月6日-1月7日，保留1月1日-1月5日）
   - 点击可扩展日期继续延长（例如点击1月8日，扩展到1月1日-1月8日）
8. 用户点击"保存"按钮
9. 返回首页，显示经期状态

---

### 5.2 日常使用流程

#### 场景1：查看今天的经期状态
1. 打开 App，首页自动显示今天的经期状态
2. 查看经期状态卡片（经期中/经期后）
3. 查看周历上的经期标记

#### 场景2：查看历史日期的经期状态
1. 在周历上点击某个历史日期
2. 或在经期状态卡片左右滑动切换日期
3. 查看该日期的经期状态

#### 场景3：记录新的经期
1. 点击"记录月经"或"编辑月经日期"按钮
2. 进入日期选择器（自动滚动到底部，显示今天所在月份）
3. 滚动到需要记录的月份
4. 点击新经期开始的日期
5. **如果满足预测条件**，系统自动选中该日期及后续 6 天（共 7 天）
6. **如果不满足预测条件**（距离其他经期太近），只选中当前日期
7. 根据实际情况调整日期选择
8. 点击"保存"
9. 返回首页，查看更新的经期状态

#### 场景4：修改已记录的经期
1. 点击"编辑月经日期"按钮
2. 进入日期选择器
3. 查看已选中的日期（红色实心圆形）
4. 点击已选中的日期取消选中
5. 或点击可扩展日期（虚线框）延长经期
6. 点击"保存"
7. 返回首页，查看更新的经期状态

#### 场景5：查看周期统计
1. 在首页月经周期信息卡片中，点击"月经周期天数变化"
2. 进入周期统计页面
3. 查看平均周期天数
4. 查看当前周期的进度
5. 查看历史周期列表
6. 点击返回按钮返回首页

#### 场景6：查看经期统计
1. 在首页月经周期信息卡片中，点击"经期长度变化"
2. 进入经期长度统计页面
3. 查看平均经期天数
4. 查看当前经期的进度（如果在经期中）
5. 查看历史经期列表
6. 点击返回按钮返回首页

---

## 六、设计规范

### 6.1 颜色主题

#### 经期状态颜色
- **经期中：** 红粉色渐变
  - 渐变色值：#FF7A94 → #FF7A94 → #FFC4C4
- **非经期：** 米白色渐变
  - 渐变色值：#FFFAF5 → #FFF5EC → #FFEEE0

#### 功能色
- **选中高亮：** 蓝色
- **经期标记：** 红色
- **今天标记：** 蓝色空心圆点
- **正常状态：** 绿色 + ✓
- **进度条：**
  - 周期进度：蓝色
  - 经期进度：红色
- **平均参考线：** 橙色虚线

#### 按钮颜色
- **未记录状态：** 白底 + 粉色文字
- **已记录状态：** 粉底 + 白色文字

---

### 6.2 交互动效

#### 滑动切换
- **周历滑动：** 切换周时，日期左右平移
- **经期状态卡片滑动：** 切换日期时，卡片左右平移
- **背景渐变过渡：** 从经期到非经期平滑渐变（使用弹性动画）

#### 按钮点击
- **记录/编辑按钮：** 点击后缩放效果，然后打开页面
- **日期格子点击：** 点击后立即改变状态（选中/取消选中）

#### 导航转场
- **进入日期选择器：** 全屏页面从底部推入
- **进入统计页面：** 从右侧推入（标准导航动画）
- **返回：** 从左侧推出（标准导航动画）

---

### 6.3 响应式设计

#### 基准设备
iPhone 15（393×852 pt）

#### 适配原则
所有尺寸、间距使用屏幕比例，而非固定像素值

**垂直方向：**
- 比例 = 设计值 / 852

**水平方向：**
- 比例 = 设计值 / 393

---

## 七、未来扩展方向

### 可能的功能扩展

#### 1. 症状记录
- 记录经期症状（腹痛、头痛、情绪等）
- 症状统计分析

#### 2. 预测功能
- 基于历史数据预测下次经期
- 预测排卵期

#### 3. 提醒功能
- 经期提醒
- 排卵期提醒
- 用药提醒

#### 4. 数据导出
- 导出经期记录为PDF
- 导出统计图表

#### 5. 数据同步
- iCloud 同步
- 多设备数据共享

#### 6. 健康数据集成
- 接入 HealthKit
- 同步健康数据

---

## 八、总结

**产品特点：**
- 简洁直观的界面设计
- 快速便捷的日期记录体验
- 清晰的数据统计展示
- 平滑流畅的交互动效

**核心优势：**
- 专注核心功能，不过度设计
- 操作流程简单，学习成本低
- 数据可视化清晰，易于理解
- 响应式设计，适配各种设备

**适用人群：**
- 需要记录和追踪月经周期的女性用户
- 希望了解自身经期规律的用户
- 追求简洁体验的用户
